<!DOCTYPE html>
<html ng-app="DBHub-front" ng-controller="databaseView">
<head>
    <meta charset="UTF-8">
    <title>DBHub.io - {{ db.Username }} / {{ db.Database }}</title>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-animate.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-sanitize.min.js"></script>
    <script src="//angular-ui.github.io/bootstrap/ui-bootstrap-tpls-2.2.0.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav, .pagination, .carousel, .panel-title a { cursor: pointer; }

        #viewupdates, #viewbranches, #viewreleases, #viewcontribs {
            margin-left: 30%;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2 id="viewuser">
                <div class="pull-left"><a href="/{{ db.Username }}">{{ db.Username }}</a> / {{ db.Database }}</div>
                <div class="btn-group pull-right">
                    <button type="button" class="btn btn-default" ng-bind="'Watchers: ' + db.Watchers"></button>
                    <button type="button" class="btn btn-default" ng-bind="'Stars: ' + db.Stars"></button>
                    <button type="button" class="btn btn-default" ng-bind="'Forks: ' + db.Forks"></button>
                </div>
            </h2>
        </div>
    </div>
    <div class="row" style="padding-bottom: 5px; padding-top: 10px;">
        <div class="col-md-10">
            <div class="row">
                <div class="col-md-2">
                    <a href="">Data</a>
                </div>
                <div class="col-md-2">
                    <a href="">Visualise</a>
                </div>
                <div class="col-md-2">
                    <a href="">Schedule</a>
                </div>
                <div class="col-md-2">
                    <label id="viewdiscuss"><a href="">{{ 'Discussions: ' }}</a>{{ db.Discussions }}</label>
                </div>
                <div class="col-md-2">
                    <label id="viewprs"><a href="">{{ 'Pull Requests: ' }}</a>{{ db.PRs }}</label>
                </div>
                <div class="col-md-2">
                    <a href="">Statistics</a>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            &nbsp;
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="well well-sm" style="margin-bottom: 10px;">
                <label id="viewdesc" ng-bind="db.Description"></label>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table width="100%" class="table table-bordered" style="margin-bottom: 10px;">
                <tr>
                    <td>
                        <label id="viewupdates" ng-bind="'Updates: ' + db.Updates"></label>
                    </td>
                    <td>
                        <label id="viewbranches" ng-bind="'Branches: ' + db.Branches"></label>
                    </td>
                    <td>
                        <label id="viewreleases" ng-bind="'Releases: ' + db.Releases"></label>
                    </td>
                    <td>
                        <label id="viewcontribs" ng-bind="'Contributors: ' + db.Contributors"></label>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row" style="padding-bottom: 10px;">
        <div class="dropdown col-md-5">
            <div class="btn-group" uib-dropdown keyboard-nav="true">
                <button id="viewtable" type="button" class="btn">{{ 'Table: ' + db.Tablename }}</button>

                <button type="button" uib-dropdown-toggle class="btn btn-default">
                    <span class="caret"></span>
                </button>
                <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                    <li ng-repeat="row in db.Tables" role="menuitem" ng-click="changeTable(row)">
                        <a href="#{{ row }}">{{ row }}</a>
                    </li>
                </ul>
                <button class="btn btn-default">New Pull Request</button>
            </div>
        </div>
        <div class="col-md-1">
            &nbsp;
        </div>
        <div class="col-md-6">
            <button class="btn btn-default pull-right">Download</button>
            <button class="btn btn-default pull-right">Upload database</button>
            <button class="btn btn-default pull-right">Create new database</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table class="table table-bordered table-striped table-responsive">
                <tr>
                    <th ng-repeat="header in db.TableHeaders">{{ header }}</th>
                </tr>
                <tr ng-repeat="row in db.Records">
                    <td ng-repeat="val in row"><span ng-bind-html="trustAsHtml(printValue(val.Value))"></span></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="page-header">
                <h1>README</h1>
            </div>
            <label id="viewreadme" ng-bind="db.Readme"></label>
        </div>
    </div>
</div>

<script>
    var app = angular.module('DBHub-front', ['ui.bootstrap']);
    app.controller('databaseView', function($scope, $http, $sce) {
        $scope.db = { Username: "[[ .Username ]]",
                      Database: "[[ .Database ]]",
                      Watchers: "[[ .Watchers ]]",
                      Tablename: "[[ .Tablename ]]",
                      Stars: "[[ .Stars ]]",
                      Forks: "[[ .Forks ]]",
                      Discussions: "[[ .Discussions ]]",
                      PRs: "[[ .PRs ]]",
                      Description: "[[ .Description ]]",
                      Updates: "[[ .Updates ]]",
                      Branches: "[[ .Branches ]]",
                      Releases: "[[ .Releases ]]",
                      Contributors: "[[ .Contributors ]]",
                      Readme: "[[ .Readme ]]",
                      Tables: [[ .Tables ]],
                      Records: [[ .Records ]],
                      TableHeaders: [[ .TableHeaders ]]
        }
        $scope.changeTable = function(newtable) {
            $http.get("http://localhost:9080/foo/devcrapdb1.sqlite?" + newtable)
                .then(function (response) { $scope.db = response.data; })
        }
        $scope.printValue = function(fieldVal) {
            if (fieldVal == "") {
                fieldVal = "&nbsp;"
            }
            return fieldVal
        }
        // FIXME: Using $sce.trustAsHtml in this way seems like a security risk, as it will probably allow embedded
        // FIXME  HTML (in a user database field) to be presented unescaped.  Find a better way.  Maybe an AngularJS
        // FIXME  filter instead?
        $scope.trustAsHtml = $sce.trustAsHtml;
    });
</script>
</body>
</html>