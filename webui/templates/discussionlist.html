[[ define "discussListPage" ]]
<!doctype html>
<html ng-app="DBHub" ng-controller="discussListView">
[[ template "headawesome" . ]]
<body>
<style>
    .notImplementedYet {
        color: gray;
        text-decoration: none;
    }

    .notImplementedYet:hover {
        color: gray;
        text-decoration: none;
    }
</style>
[[ template "header" . ]]
<div style="margin-left: 2%; margin-right: 2%; padding-left: 2%; padding-right: 2%;">
    <div class="row">
        <div class="col-md-12">
            <h2 id="viewdb" style="margin-top: 10px;">
                <div class="pull-left">
                    <div>
                        <a class="blackLink" href="/[[ .Meta.Owner ]]">[[ .Meta.Owner ]]</a> /
                        <a class="blackLink" href="/[[ .Meta.Owner ]]/[[ .Meta.Database ]]">[[ .Meta.Database ]]</a>
                    </div>
                    [[ if .Meta.ForkOwner ]]
                    <div style="font-size: small">
                        forked from <a href="/[[ .Meta.ForkOwner ]]">[[ .Meta.ForkOwner ]]</a> /
                        [[ if not .Meta.ForkDeleted ]]
                            <a href="/[[ .Meta.ForkOwner ]]/[[ .Meta.ForkDatabase ]]">[[ .Meta.ForkDatabase ]]</a>
                        [[ else ]]
                            deleted database
                        [[ end ]]
                    </div>
                    [[ end ]]
                </div>
                <div class="pull-right">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default" ng-disabled="true" ng-click="toggleWatch()"><i class="fa fa-eye"></i> Watch</button>
                        <button type="button" class="btn btn-default" ng-bind="meta.Watchers"></button>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-default" ng-bind-html="starsText" ng-click="toggleStars()"></button>
                        <button type="button" class="btn btn-default" ng-bind="meta.Stars" ng-click="starsPage()"></button>
                    </div>
                    <div class="btn-group">
                        [[ if ne .Meta.Owner .Meta.LoggedInUser ]]
                        <button type="button" class="btn btn-default" ng-click="forkDB()"><i class="fa fa-sitemap"></i> Fork</button>
                        [[ else ]]
                        <button type="button" class="btn btn-default" ng-disabled="true"><i class="fa fa-sitemap"></i> Fork</button>
                        [[ end ]]
                        <button type="button" class="btn btn-default" ng-bind="meta.Forks" ng-click="forksPage()"></button>
                    </div>
                </div>
            </h2>
        </div>
    </div>
    <div class="row" style="padding-bottom: 5px; padding-top: 10px;">
        <div class="col-md-12">
            <label id="viewdata" style="font-weight: 600; font-family: 'arial black';"><a href="/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" title="Data"><i class="fa fa-database"></i> Data</a></label> &nbsp; &nbsp; &nbsp;
            <label id="viewdiscuss" style="font-weight: 600; font-family: 'arial black'; border-bottom: 1px grey dashed;"><a href="/discuss/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" title="Discussions"><i class="fa fa-commenting"></i> Discussions:</a> {{ meta.Discussions }}</label> &nbsp; &nbsp; &nbsp;
            <label id="viewmrs" style="font-weight: 600; font-family: 'arial black';"><a href="" class="notImplementedYet" title="Not yet implemented"><i class="fa fa-clone"></i> Merge Requests: </a>{{ meta.MRs }}</label> &nbsp; &nbsp; &nbsp;
            [[ if eq .Meta.Owner .Meta.LoggedInUser ]]
            <label id="settings" style="font-weight: 600; font-family: 'arial black';"><a class="blackLink" href="/settings/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"><i class="fa fa-cog"></i> Settings</a></label>
            [[ end ]]
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="pull-left">
                <button class="btn btn-success" ng-click="createDiscussion()">Start a new discussion</button>
                <div class="btn-group">
                    <label class="btn btn-default" ng-model="radioOpen" ng-click="openClick('true')" uib-btn-radio="true">Open</label>
                    <label class="btn btn-default" ng-model="radioOpen" ng-click="openClick('false')" uib-btn-radio="false">Closed</label>
                </div>

            </div>
            <br /><br />
        </div>
    </div>
    <div class="row" ng-if="statusMessage != ''">
        <div class="col-md-12">
            <div style="text-align: center; padding-bottom: 8px;">
                <h4 style="color: {{ statusMessageColour }};">&nbsp;{{ statusMessage }}</h4>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table ng-if="DiscussionList != ''" class="table table-striped table-responsive">
                <tbody>
                    <tr ng-repeat="row in DiscussionList" ng-if="row.open == radioOpen">
                        <td style="border-style: none;" width="5%">
                            <div style="padding-top: 6px;"># {{ row.disc_id }}</div>
                        </td>
                        <td style="border-style: none;">
                            <a href="/discuss/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?id={{ row.disc_id }}" style="font-size: x-large; color: #333;">{{ row.title }}</a>
                            <div>
                                <span>Last modified on {{ row.last_modified | date : 'd MMM y h:mm a' }} by <a class="blackLink" href="/{{ row.creator }}">{{ row.creator }}</a></span> &nbsp;
                                <span ng-if="row.comment_count > 0"><i class="fa fa-comment-o"></i> <a class="blackLink" href="/discuss/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?id={{ row.disc_id }}">{{ row.comment_count }} comment<span ng-if="row.comment_count > 1">s</span></a></span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div ng-if="DiscussionList == null" style="text-align: center; font-size:large; padding-bottom: 20px;"><i>This database doesn't have any discussions yet</i></div>
        </div>
    </div>
</div>
[[ template "footer" . ]]
<script>
    var app = angular.module('DBHub', ['ui.bootstrap', 'ngSanitize']);
    app.controller('discussListView', function($scope, $http) {
        // Pre-filled data
        $scope.meta = {
            Database: "[[ .Meta.Database ]]",
            Discussions: "[[ .DB.Info.Discussions ]]",
            Forks: "[[ .DB.Info.Forks ]]",
            MRs: "[[ .DB.Info.MRs ]]",
            MyStar: "[[  .MyStar ]]",
            Owner: "[[ .Meta.Owner ]]",
            Stars: "[[ .DB.Info.Stars ]]",
            Watchers: "[[ .DB.Info.Watchers ]]",
            [[ if .Meta.LoggedInUser ]]
                Loggedin: "true",
            [[ else ]]
                Loggedin: "false",
            [[ end ]]
        }

        $scope.statusMessage = "";
        $scope.DiscussionList = [[ .DiscussionList ]];

        // Switch to the create discussion page
        $scope.createDiscussion = function() {
            if ($scope.meta.Loggedin != "true") {
                // User needs to be logged in
                lock.show();
            } else {
                window.location = '/creatediscuss/[[ .Meta.Owner ]]/[[ .Meta.Database ]]';
            }
        };

        // Switch between showing open vs closed discussions
        $scope.radioOpen = true;
        $scope.openClick = function(newValue) {
            if (newValue === "true") {
                // Only display open discussions
                $scope.radioOpen = true;
            } else {
                // Only display closed discussions
                $scope.radioOpen = false;
            }
        };

        // Sends the user to the stars page for the database
        $scope.starsPage = function() {
            window.location = "/stars/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"
        };

        // Sends the user to the login page (if not logged in), else toggles starring of the database for the user
        $scope.toggleStars = function() {
            if ($scope.meta.Loggedin != "true") {
                // User needs to be logged in
                lock.show();
            } else {
                $http.get("/x/star/[[ .Meta.Owner ]]/[[ .Meta.Database ]]")
                    .then(function (response) {
                        var tempval = response.data;
                        if (tempval != "-1") {
                            // Update star button text
                            if ($scope.meta.MyStar != "true") {
                                $scope.meta.MyStar = "true";
                            } else {
                                $scope.meta.MyStar = "false";
                            }
                            $scope.updateStarsText();

                            // Update displayed star count
                            $scope.meta.Stars = tempval;
                        }
                    })
            }
        };

        // Update star button text to say "Stars" or "Unstar"
        $scope.starsText = "<i class=\"fa fa-star\"></i> Star";
        $scope.updateStarsText = function() {
            if ($scope.meta.MyStar != "true") {
                $scope.starsText = "<i class=\"fa fa-star\"></i> Star";
            } else {
                $scope.starsText = "<i class=\"fa fa-star\"></i> Unstar";
            }
        };
        $scope.updateStarsText();

        // Auth0
        var lock = new Auth0Lock("[[ .Auth0.ClientID ]]", "[[ .Auth0.Domain ]]", { auth: {
            redirectUrl: "[[ .Auth0.CallbackURL]]"
        }});
        $scope.showLock = function() {
            lock.show();
        };
    });
</script>
</body>
</html>
[[ end ]]