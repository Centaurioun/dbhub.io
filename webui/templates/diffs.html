[[ define "diffPage" ]]
<!doctype html>
<html ng-app="DBHub" ng-controller="diffView">
[[ template "head" . ]]
<body>
[[ template "header" . ]]
<div style="margin-left: 2%; margin-right: 2%; padding-left: 2%; padding-right: 2%;">
    [[ template "headerdatabase" . ]]
    <div class="row" ng-if="statusMessage != ''">
        <div class="col-md-12">
            <div style="text-align: center; padding-bottom: 8px;">
                <h4 style="color: {{ statusMessageColour }};">&nbsp;{{ statusMessage }}</h4>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12" style="padding-bottom: 10px;">
        [[ if .Diffs.Diff ]]
            <table ng-if="Diffs != null" class="table table-striped table-responsive settingsTable">
                <tbody>
                    <tr ng-repeat="row in Diffs">
                        <td style="border-style: none;">
                            <span style="font-size: x-large; color: #333;">{{ row.object_name }}</span><br />
                            <span style="color: #333;">{{ row.object_type }}</span>
                            <div>
                            </div>
                        </td>
                        <td style="border-style: none;">
                            <div class="pull-left" style="padding-top: 6px;">
                                <span ng-if="row.schema != null && row.schema.action_type=='add'" style="font-weight: bold;">
                                    Created {{ row.object_type }}<br />
                                </span>
                                <span ng-if="row.schema != null && row.schema.action_type=='delete'" style="font-weight: bold;">
                                    Dropped {{ row.object_type }}<br />
                                </span>
                                <span ng-if="row.schema != null && row.schema.action_type=='modify'" style="font-weight: bold;">
                                    Schema changed<br />
                                </span>
                                <span ng-if="row.data.length">{{ row.data.length }} rows changed:</span>
                            </div>
                            <table ng-if="row.data.length" class="table table-responsive settingsTable">
                                <thead>
                                    <tr>
                                        <td ng-repeat="c in ColumnNamesBefore[row.object_name]">{{ c }}</td>
                                        <td ng-repeat="c in ColumnNamesAfter[row.object_name]">{{ c }}</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="d in row.data">
                                        <td ng-if="d.action_type != 'add'" style="background-color: #ffeef0;" ng-repeat="c in d.data_before track by $index">
                                            <span style="{{ c != d.data_after[$index] ? 'background-color: #fdb8c0;' : '' }}">{{ c }}</span>
                                        </td>
                                        <td ng-if="d.action_type == 'add'" ng-repeat="c in ColumnNamesBefore[row.object_name]">
                                        </td>
                                        <td ng-if="d.action_type != 'delete'" style="background-color: #e6ffed;" ng-repeat="c in d.data_after track by $index">
                                            <span style="{{ c != d.data_before[$index] ? 'background-color: #acf2bd;' : '' }}">{{ c }}</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        [[ else ]]
            <h4>No changes</h4>
        [[ end ]]
        </div>
    </div>
</div>
[[ template "footer" . ]]
<script>
    var app = angular.module('DBHub', ['ui.bootstrap', 'ngSanitize']);
    app.controller('diffView', function($scope, $http) {
        // Pre-filled data
        $scope.meta = {
            Database:    "[[ .Meta.Database ]]",
            Discussions: "[[ .DB.Info.Discussions ]]",
            Forks:       "[[ .DB.Info.Forks ]]",
            MRs:         "[[ .DB.Info.MRs ]]",
            MyStar:      "[[ .MyStar ]]",
            MyWatch:     "[[ .MyWatch ]]",
            Owner:       "[[ .Meta.Owner ]]",
            Stars:       "[[ .DB.Info.Stars ]]",
            Watchers:    "[[ .DB.Info.Watchers ]]",
            [[ if .Meta.LoggedInUser ]]
                Loggedin: "true",
            [[ else ]]
                Loggedin: "false",
            [[ end ]]
        }

        $scope.statusMessage = "";
        $scope.Diffs = [[ .Diffs.Diff ]];
        $scope.ColumnNamesBefore = [[ .ColumnNamesBefore ]];
        $scope.ColumnNamesAfter = [[ .ColumnNamesAfter ]];

        // Change \u0026 to &
        $scope.decodeAmp = function(str) {
            return decodeURIComponent(str);
        };

        // Sends the user to the forks page for the database
        $scope.forksPage = function() {
            window.location = "/forks/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"
        };

        // Returns a nicely presented "time elapsed" string
        $scope.getTimePeriodTxt = function(date1, includeOn) {
            return getTimePeriod(date1, includeOn)
        };

        // Sends the user to the stars page for the database
        $scope.starsPage = function() {
            window.location = "/stars/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"
        };

        // Sends the user to the login page (if not logged in), else toggles starring of the database for the user
        $scope.toggleStars = function() {
            if ($scope.meta.Loggedin != "true") {
                // User needs to be logged in
                lock.show();
            } else {
                $http.get("/x/star/[[ .Meta.Owner ]]/[[ .Meta.Database ]]")
                    .then(function (response) {
                        var tempval = response.data;
                        if (tempval != "-1") {
                            // Update star button text
                            if ($scope.meta.MyStar != "true") {
                                $scope.meta.MyStar = "true";
                            } else {
                                $scope.meta.MyStar = "false";
                            }
                            $scope.updateStarsText();

                            // Update displayed star count
                            $scope.meta.Stars = tempval;
                        }
                    })
            }
        };

        // Turns on watching for a database
        $scope.toggleWatchers = function() {
            if ($scope.meta.Loggedin != "true") {
                // User needs to be logged in
                lock.show();
                return;
            }

            // Retrieve the branch list for the newly selected database
            $http.get("/x/watch/[[ .Meta.Owner ]]/[[ .Meta.Database ]]")
                .then(function (response) {
                    // Update watch button text
                    if ($scope.meta.MyWatch != "true") {
                        $scope.meta.MyWatch = "true";
                    } else {
                        $scope.meta.MyWatch = "false";
                    }
                    $scope.updateWatchersText();

                    // Update displayed watcher count
                    $scope.meta.Watchers = response.data;
                });
        };

        // Update star button text to say "Stars" or "Unstar"
        $scope.starsText = "<i class=\"fa fa-star\"></i> Star";
        $scope.updateStarsText = function() {
            if ($scope.meta.MyStar != "true") {
                $scope.starsText = "<i class=\"fa fa-star\"></i> Star";
            } else {
                $scope.starsText = "<i class=\"fa fa-star\"></i> Unstar";
            }
        };
        $scope.updateStarsText();

        // Update watchers button text to say "Watch" or "Unwatch"
        $scope.watchersText = "<i class=\"fa fa-eye\"></i> Watch";
        $scope.updateWatchersText = function() {
            if ($scope.meta.MyWatch != "true") {
                $scope.watchersText = "<i class=\"fa fa-eye\"></i> Watch";
            } else {
                $scope.watchersText = "<i class=\"fa fa-eye\"></i> Unwatch";
            }
        };
        $scope.updateWatchersText();

        // Sends the user to the watchers page for the database
        $scope.watchersPage = function() {
            window.location = "/watchers/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"
        };

        // Auth0
        var lock = new Auth0Lock("[[ .Auth0.ClientID ]]", "[[ .Auth0.Domain ]]", { auth: {
            redirectUrl: "[[ .Auth0.CallbackURL]]"
        }});
        $scope.showLock = function() {
            lock.show();
        };
    });
</script>
</body>
</html>
[[ end ]]
