[[ define "apipermsPage" ]]
<!doctype html>
<html ng-app="DBHub" ng-controller="apipermsView">
[[ template "head" . ]]
<body>
[[ template "header" . ]]
<div style="margin-left: 2%; margin-right: 2%; padding-left: 2%; padding-right: 2%;">


  <table class="table table-striped table-responsive settingsTable" style="margin-bottom: 20px;">
    <tr>
      <th>Key</th>
      <th>Generation date</th>
      <th>Database(s)</th>
      <th>Allowed function calls</th>
    </tr>
    <tr ng-repeat="api in apiKeys">
      <td><p style="font-family: monospace, monospace; text-align: center;">{{ api.key }}</p>
        <div style="text-align: center;">
          <input type="submit" class="btn btn-primary" value="Revoke" ng-click="apiKeyRevoke(api.key)">
        </div>
      </td>
      <td>{{ api.date_created | date : 'medium' }}</td>
      <td>
        <div class="btn-group" uib-dropdown keyboard-nav="true">
          <button id="viewtable" type="button" class="btn">{{ api.database_name }}</button>

          <button type="button" uib-dropdown-toggle class="btn btn-default">
            <span class="caret"></span>
          </button>
          <ul uib-dropdown-menu class="dropdown-menu" role="menu">
            <li role="menuitem" ng-click="allDBs(api.key)">
              <a href="">All databases</a>
            </li>
            <li class="divider"></li>
            <li ng-repeat="database in dbList | orderBy" role="menuitem" ng-click="selectDB(api.key, database)">
              <a href="">{{ database }}</a>
            </li>
          </ul>
        </div>
      </td>
      <td>
        <table class="table table-striped table-responsive settingsTable">
          <tr>
            <th>Branches()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioBranches" ng-click="apiPermUpdate(api.key, 'branches', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioBranches" ng-click="apiPermUpdate(api.key, 'branches', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
            <th>Metadata()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioMetadata" ng-click="apiPermUpdate(api.key, 'metadata', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioMetadata" ng-click="apiPermUpdate(api.key, 'metadata', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>Columns()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioColumns" ng-click="apiPermUpdate(api.key, 'columns', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioColumns" ng-click="apiPermUpdate(api.key, 'columns', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
            <th>Query()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioQuery" ng-click="apiPermUpdate(api.key, 'query', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioQuery" ng-click="apiPermUpdate(api.key, 'query', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>Commits()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioCommits" ng-click="apiPermUpdate(api.key, 'commits', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioCommits" ng-click="apiPermUpdate(api.key, 'commits', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
            <th>Releases()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioReleases" ng-click="apiPermUpdate(api.key, 'releases', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioReleases" ng-click="apiPermUpdate(api.key, 'releases', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>Databases()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioDatabases" ng-click="apiPermUpdate(api.key, 'databases', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioDatabases" ng-click="apiPermUpdate(api.key, 'databases', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
            <th>Tables()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioTables" ng-click="apiPermUpdate(api.key, 'tables', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioTables" ng-click="apiPermUpdate(api.key, 'tables', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>Delete()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioDelete" ng-click="apiPermUpdate(api.key, 'delete', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioDelete" ng-click="apiPermUpdate(api.key, 'delete', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
            <th>Tags()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioTags" ng-click="apiPermUpdate(api.key, 'tags', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioTags" ng-click="apiPermUpdate(api.key, 'tags', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>Diff()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioDiff" ng-click="apiPermUpdate(api.key, 'diff', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioDiff" ng-click="apiPermUpdate(api.key, 'diff', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
            <th>Upload()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioUpload" ng-click="apiPermUpdate(api.key, 'upload', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioUpload" ng-click="apiPermUpdate(api.key, 'upload', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>Download()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioDownload" ng-click="apiPermUpdate(api.key, 'download', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioDownload" ng-click="apiPermUpdate(api.key, 'download', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
            <th>Views()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioViews" ng-click="apiPermUpdate(api.key, 'views', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioViews" ng-click="apiPermUpdate(api.key, 'views', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>Indexes()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioIndexes" ng-click="apiPermUpdate(api.key, 'indexes', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioIndexes" ng-click="apiPermUpdate(api.key, 'indexes', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
            <th>Webpage()</th>
            <td>
              <div class="btn-group">
                <label class="btn btn-default" ng-model="radioWebpage" ng-click="apiPermUpdate(api.key, 'webpage', 'true')" uib-btn-radio="'true'">Yes</label>
                <label class="btn btn-default" ng-model="radioWebpage" ng-click="apiPermUpdate(api.key, 'webpage', 'false')" uib-btn-radio="'false'">No</label>
              </div>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr ng-if="apiKeys === null">
      <td colspan="3" style="text-align: center;">You don't have any API keys yet</td>
    </tr>
    <tr>
      <td style="border-left: none;" colspan="4">
        <div>
          <div class="row" ng-if="statusMessage != ''">
            <div style="text-align: center; padding-bottom: 8px;">
              <h4 style="color: {{ statusMessageColour }};">&nbsp;{{ statusMessage }}</h4>
            </div>
          </div>
        </div>
        <div style="text-align: center;">
          <input type="submit" class="btn btn-primary" value="Generate new API key" ng-click="apiKeyGen()">
        </div>
      </td>
    </tr>
  </table>



</div>
[[ template "footer" . ]]
<script>
    let app = angular.module('DBHub', ['ui.bootstrap', 'ngSanitize']);
    app.controller('apipermsView', function($scope, $http, $httpParamSerializerJQLike) {

        // Database names
        $scope.dbList = [[ .DBNames ]];

        // Set initial permissions to true for the API keys
        // TODO: These will need updating, depending on what the server sets
        $scope.radioBranches = "true";
        $scope.radioColumns = "true";
        $scope.radioCommits = "true";
        $scope.radioDatabases = "true";
        $scope.radioDelete = "true";
        $scope.radioDiff = "true";
        $scope.radioDownload = "true";
        $scope.radioIndexes = "true";
        $scope.radioMetadata = "true";
        $scope.radioQuery = "true";
        $scope.radioReleases = "true";
        $scope.radioTables = "true";
        $scope.radioTags = "true";
        $scope.radioUpload = "true";
        $scope.radioViews = "true";
        $scope.radioWebpage = "true";

        // TODO: Update this to use what the server sets. eg existing value stored in the backend
        $scope.allDatabases = true;
        $scope.selectedDB = "All databases";

        // Send the changed database selection to the server
        $scope.changeDB = function(apiKey, newDB) {
            // Send the new database info to the server
            $http({
                method: "POST",
                url: "/x/apikeydbupdate/",
                data: $httpParamSerializerJQLike({
                    "apikey": encodeURIComponent(apiKey),
                    "dbname": encodeURIComponent(newDB),
                    "alldbs": encodeURIComponent($scope.allDatabases),
                }),
                headers: { "Content-Type": "application/x-www-form-urlencoded" }
            }).then(function (response) {
                // Clear any error message
                $scope.statusMessageColour = "green";
                $scope.statusMessage = "";
            }, function failure(response) {
                $scope.statusMessageColour = "red";
                $scope.statusMessage = "Server message: " + response.data;
            });
        }

        // Select "all databases"
        $scope.allDBs = function(apiKey) {
            $scope.selectedDB = "All databases";
            $scope.allDatabases = true;

            // Send the change to the backend
            $scope.changeDB(apiKey, "");
        }

        // Change the selected database
        $scope.selectDB = function(apiKey, newDB) {
            $scope.selectedDB = newDB;
            $scope.allDatabases = false;

            // Send the change to the backend
            $scope.changeDB(apiKey, newDB);
        }

        // Auth0
        let lock = new Auth0Lock("[[ .Auth0.ClientID ]]", "[[ .Auth0.Domain ]]", { auth: {
            redirectUrl: "[[ .Auth0.CallbackURL]]"
        }});

        $scope.showLock = function() {
            lock.show();
        };
    });
</script>
</body>
</html>
[[ end ]]