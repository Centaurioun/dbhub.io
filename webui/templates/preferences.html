[[ define "prefPage" ]]
<!doctype html>
<html ng-app="DBHub" ng-controller="prefView">
[[ template "head" . ]]
<body>
[[ template "header" . ]]
<div style="margin-left: 2%; margin-right: 2%; padding-left: 2%; padding-right: 2%;">
    <div class="row">
        <div class="col-md-1">
            &nbsp;
        </div>
        <div class="col-md-10">
            <h2 style="text-align: center;">Settings</h2>
            <h3 style="text-align: center;">Used when uploading databases</h3>
            <form action="/pref" method="post">
                <table class="table table-striped table-responsive settingsTable">
                    <tr>
                        <th width="25%">Full Name</th>
                        <td><input name="fullname" style="width: 100%;" value="{{ FullName }}" ng-attr-placeholder="{{ NamePlaceholder }}" maxlength="80"></td>
                    </tr>
                    <tr>
                        <th>Email address</th>
                        <td><input name="email" style="width: 100%;" value="{{ EmailAddr }}" ng-attr-placeholder="{{ EmailPlaceholder }}" maxlength="80"><br />
                            <i>If you don't want to use your real email address, use
                                "[[ .Meta.LoggedInUser ]]@[[ .Meta.Server ]]".</i></td>
                    </tr>
                </table>
                <h3 style="text-align: center;">Display options</h3>
                <table class="table table-striped table-responsive settingsTable" style="margin-bottom: 20px;">
                    <tr>
                        <th>Maximum number of database rows to display</th>
                        <td><input type="number" name="maxrows" value="[[ .MaxRows ]]" min="1" max="500"></td>
                    </tr>
                    <tr>
                        <td style="border-left: none;" colspan="2">
                            <div style="text-align: center;">
                                <input type="submit" class="btn btn-primary" value="Update">
                            </div>
                        </td>
                    </tr>
                </table>
            </form>

            <h3 style="text-align: center;"><a href="https://api.dbhub.io" target="_blank">API keys</a></h3>
            <div style="text-align: center; font-style: italic; font-size: large;">(In early development, but you're welcome to use it.)</div>
            <table class="table table-striped table-responsive settingsTable" style="margin-bottom: 20px;">
                <tr>
                    <th>Key</th>
                    <th>Generation date</th>
                    <th>Databases</th>
                    <th>Allowed function calls</th>
                </tr>
                <tr ng-repeat="row in apiKeys">
                    <td><p style="font-family: monospace, monospace; text-align: center;">{{ row.key }}</p>
                        <div style="text-align: center;">
                            <input type="submit" class="btn btn-primary" value="Revoke" ng-click="apiKeyRevoke()">
                        </div>
                    </td>
                    <td>{{ row.date_created | date : 'medium' }}</td>
                    <td>
                        <div class="btn-group" uib-dropdown keyboard-nav="true">
                            <button id="viewtable" type="button" class="btn">{{ selectedDB }}</button>

                            <button type="button" uib-dropdown-toggle class="btn btn-default">
                                <span class="caret"></span>
                            </button>
                            <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                <li ng-repeat="database in dbList" role="menuitem" ng-click="changeDB(database)">
                                    <a href="">{{ database }}</a>
                                </li>
                            </ul>
                        </div>
                    </td>
                    <td>
                        <table class="table table-striped table-responsive settingsTable">
                            <tr>
                                <th>Branches()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioBranches" ng-click="branchesClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioBranches" ng-click="branchesClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                                <th>Metadata()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioMetadata" ng-click="metadataClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioMetadata" ng-click="metadataClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Columns()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioColumns" ng-click="columnsClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioColumns" ng-click="columnsClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                                <th>Query()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioQuery" ng-click="queryClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioQuery" ng-click="queryClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Commits()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioCommits" ng-click="commitsClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioCommits" ng-click="commitsClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                                <th>Releases()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioReleases" ng-click="releasesClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioReleases" ng-click="releasesClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Databases()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioDatabases" ng-click="databasesClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioDatabases" ng-click="databasesClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                                <th>Tables()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioTables" ng-click="tablesClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioTables" ng-click="tablesClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Delete()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioDelete" ng-click="deleteClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioDelete" ng-click="deleteClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                                <th>Tags()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioTags" ng-click="tagsClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioTags" ng-click="tagsClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Diff()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioDiff" ng-click="diffClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioDiff" ng-click="diffClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                                <th>Upload()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioUpload" ng-click="uploadClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioUpload" ng-click="uploadClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Download()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioDownload" ng-click="downloadClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioDownload" ng-click="downloadClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                                <th>Views()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioViews" ng-click="viewsClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioViews" ng-click="viewsClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>Indexes()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioIndexes" ng-click="indexesClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioIndexes" ng-click="indexesClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                                <th>Webpage()</th>
                                <td>
                                    <div class="btn-group">
                                        <label class="btn btn-default" ng-model="radioWebpage" ng-click="webpageClick('true')" uib-btn-radio="'true'">Yes</label>
                                        <label class="btn btn-default" ng-model="radioWebpage" ng-click="webpageClick('false')" uib-btn-radio="'false'">No</label>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr ng-if="apiKeys === null">
                    <td colspan="3" style="text-align: center;">You don't have any API keys yet</td>
                </tr>
                <tr>
                    <td style="border-left: none;" colspan="4">
                        <div>
                            <div class="row" ng-if="statusMessage != ''">
                                <div style="text-align: center; padding-bottom: 8px;">
                                    <h4 style="color: {{ statusMessageColour }};">&nbsp;{{ statusMessage }}</h4>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <input type="submit" class="btn btn-primary" value="Generate new API key" ng-click="apiKeyGen()">
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <div class="col-md-1">
            &nbsp;
        </div>
    </div>
</div>
[[ template "footer" . ]]
<script>
    var app = angular.module('DBHub', ['ui.bootstrap', 'ngSanitize']);
    app.controller('prefView', function($scope, $http, $httpParamSerializerJQLike) {
        // API Keys
        $scope.apiKeys = [[ .APIKeys ]];

        // Set initial permissions to true for the API keys
        $scope.radioBranches = "true";
        $scope.radioColumns = "true";
        $scope.radioCommits = "true";
        $scope.radioDatabases = "true";
        $scope.radioDelete = "true";
        $scope.radioDiff = "true";
        $scope.radioDownload = "true";
        $scope.radioIndexes = "true";
        $scope.radioMetadata = "true";
        $scope.radioQuery = "true";
        $scope.radioReleases = "true";
        $scope.radioTables = "true";
        $scope.radioTags = "true";
        $scope.radioUpload = "true";
        $scope.radioViews = "true";
        $scope.radioWebpage = "true";

        // Placeholder values
        // TODO: ...
        $scope.dbList = ["SomeDatabase", "AnotherDatabase", "MyDatabase"];
        $scope.selectedDB = "MyDatabase";


        // If the supplied display name is blank, we set a placeholder value instead
        $scope.FullName = "";
        $scope.NamePlaceholder = "";
        if ("[[ .DisplayName ]]" == "") {
            $scope.NamePlaceholder = "Jane Doe";
        } else {
            $scope.FullName = "[[ .DisplayName ]]";
        }

        // Same thing, but for email address
        $scope.EmailAddr = "";
        $scope.EmailPlaceholder = "";
        if ("[[ .Email ]]" == "") {
            $scope.EmailPlaceholder = "[[ .Meta.LoggedInUser ]]@[[ .Meta.Server ]]";
        } else {
            $scope.EmailAddr = "[[ .Email ]]";
        }

        // Auth0
        let lock = new Auth0Lock("[[ .Auth0.ClientID ]]", "[[ .Auth0.Domain ]]", { auth: {
            redirectUrl: "[[ .Auth0.CallbackURL]]"
        }});

        $scope.showLock = function() {
            lock.show();
        };

        // Generate a new API key
        $scope.statusMessage = "";
        $scope.statusMessageColour = "red";
        $scope.apiKeyGen = function() {
            // Call the server to generate a new API key
            $http.get("/x/apikeygen").then(
                function success(response) {
                    $scope.statusMessageColour = "green";
                    $scope.statusMessage = "New API key '" + response.data["key"] + "' created";

                    // Append the new key to the displayed list
                    let newKey = {"key": response.data["key"], "date_created": response.data["date_created"]};
                    if ($scope.apiKeys !== null) {
                        $scope.apiKeys.push(newKey);
                    } else {
                        $scope.apiKeys = [newKey];
                    }

                }, function failure(response) {
                    // Key creation failed, so display the returned error message
                    $scope.statusMessageColour = "red";
                    $scope.statusMessage = "Creating new API key failed: " + response.data;
                }
            )
        };
    });
</script>
</body>
</html>
[[ end ]]
